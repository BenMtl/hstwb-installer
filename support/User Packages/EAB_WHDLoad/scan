Assign EABWHDLOADDIR: "PC:Commodore_Amiga_-_WHDLoad_-_Games"


; delete temp eab whdload install directory, if it exists
IF EXISTS SYS:T/_eab-whdload-install
  Delete SYS:T/_eab-whdload-install ALL >NIL:
ENDIF

; make temp eab whdload install directory
MakePath SYS:T/_eab-whdload-install >NIL:

; search for *.lha and *.lzx files in eabwhdloaddir:
fsearch EABWHDLOADDIR: PAT="#?.lha" ALL >SYS:T/_eab-whdload-install/entries
fsearch EABWHDLOADDIR: PAT="#?.lzx" ALL >>SYS:T/_eab-whdload-install/entries 

; alpabeticallt sort eab whdload files
frsort <SYS:T/_eab-whdload-install/entries >SYS:T/_eab-whdload-install/entries_sorted 

;fsearch EABWHDLOADDIR: PAT="#?_de(_|.)#?(lha|lzx)" ALL >>PC:_de 
;fsearch EABWHDLOADDIR: PAT="#?_es(_|.)#?(lha|lzx)" ALL >>PC:_es 
;SKIP end


set entriescount `wc -l <SYS:T/_eab-whdload-install/entries_sorted` 
set entrylinenumber "1"
set currententryindex "$entryindex"

echo ""
echo "*e[32m" NOLINE
echo "Building install script for $entriescount entries:"
echo "*e[0m*e[1m" NOLINE 


; get next entry file
LAB nextentryfile

; end, if entry index is greater than entries count
IF $entrylinenumber gt $entriescount VAL
  SKIP end
ENDIF

; get next entry file from entry files
set entryfile ""
echo "$entrylinenumber" >T:_entrylinenumber
set entrylinenumberregexp "`sed "s/\(.\)*$/\1q;d/" T:_entrylinenumber`"
set entryfile "`sed "$entrylinenumberregexp" "SYS:T/_eab-whdload-install/files_sorted"`"

; goto end, if entry file is empty
IF "$entryfile" EQ ""
  SKIP BACK nextentryfile
ENDIF

echo "$entryfile"

echo "$entryfile" >T:_entryfile
Rep T:_entryfile "EABWHDLOADDIR:" ""


; detect language
; ---------------
LAB detectlanguage

; set language to en by default
set language "en"

search T:_entryfile "_de_" >NIL:
IF $RC EQ 0 VAL
  set language "de"
  SKIP detecthardware
ENDIF

search T:_entryfile "_de." >NIL:
IF $RC EQ 0 VAL
  set language "de"
  SKIP detecthardware
ENDIF

search T:_entryfile "_fr_" >NIL:
IF $RC EQ 0 VAL
  set language "fr"
  SKIP detecthardware
ENDIF

search T:_entryfile "_fr." >NIL:
IF $RC EQ 0 VAL
  set language "fr"
  SKIP detecthardware
ENDIF

search T:_entryfile "_it_" >NIL:
IF $RC EQ 0 VAL
  set language "it"
  SKIP detecthardware
ENDIF

search T:_entryfile "_it." >NIL:
IF $RC EQ 0 VAL
  set language "it"
  SKIP detecthardware
ENDIF

search T:_entryfile "_se_" >NIL:
IF $RC EQ 0 VAL
  set language "se"
  SKIP detecthardware
ENDIF

search T:_entryfile "_se." >NIL:
IF $RC EQ 0 VAL
  set language "se"
  SKIP detecthardware
ENDIF

search T:_entryfile "_pl_" >NIL:
IF $RC EQ 0 VAL
  set language "pl"
  SKIP detecthardware
ENDIF

search T:_entryfile "_pl." >NIL:
IF $RC EQ 0 VAL
  set language "pl"
  SKIP detecthardware
ENDIF

search T:_entryfile "_es_" >NIL:
IF $RC EQ 0 VAL
  set language "es"
  SKIP detecthardware
ENDIF

search T:_entryfile "_es." >NIL:
IF $RC EQ 0 VAL
  set language "es"
  SKIP detecthardware
ENDIF

search T:_entryfile "_cz_" >NIL:
IF $RC EQ 0 VAL
  set language "cz"
  SKIP detecthardware
ENDIF

search T:_entryfile "_cz." >NIL:
IF $RC EQ 0 VAL
  set language "cz"
  SKIP detecthardware
ENDIF

search T:_entryfile "_dk_" >NIL:
IF $RC EQ 0 VAL
  set language "dk"
  SKIP detecthardware
ENDIF

search T:_entryfile "_dk." >NIL:
IF $RC EQ 0 VAL
  set language "dk"
  SKIP detecthardware
ENDIF

search T:_entryfile "_fi_" >NIL:
IF $RC EQ 0 VAL
  set language "fi"
  SKIP detecthardware
ENDIF

search T:_entryfile "_fi." >NIL:
IF $RC EQ 0 VAL
  set language "fi"
  SKIP detecthardware
ENDIF

search T:_entryfile "_gr_" >NIL:
IF $RC EQ 0 VAL
  set language "gr"
  SKIP detecthardware
ENDIF

search T:_entryfile "_gr." >NIL:
IF $RC EQ 0 VAL
  set language "gr"
  SKIP detecthardware
ENDIF

search T:_entryfile "_cv_" >NIL:
IF $RC EQ 0 VAL
  set language "cv"
  SKIP detecthardware
ENDIF

search T:_entryfile "_cv." >NIL:
IF $RC EQ 0 VAL
  set language "cv"
  SKIP detecthardware
ENDIF


; detect hardware
; ---------------
LAB detecthardware

; set hardware to ocs by default
set hardware "ocs"

search T:_entryfile "_aga_" >NIL:
IF $RC EQ 0 VAL
  set hardware "aga"
  SKIP buildinstall
ENDIF

search T:_entryfile "_aga." >NIL:
IF $RC EQ 0 VAL
  set hardware "aga"
  SKIP buildinstall
ENDIF

search T:_entryfile "_cd32_" >NIL:
IF $RC EQ 0 VAL
  set hardware "cd32"
  SKIP buildinstall
ENDIF

search T:_entryfile "_cd32." >NIL:
IF $RC EQ 0 VAL
  set hardware "cd32"
  SKIP buildinstall
ENDIF

search T:_entryfile "_cdtv_" >NIL:
IF $RC EQ 0 VAL
  set hardware "cdtv"
  SKIP buildinstall
ENDIF

search T:_entryfile "_cdtv." >NIL:
IF $RC EQ 0 VAL
  set hardware "cdtv"
  SKIP buildinstall
ENDIF


; build install
; -------------
LAB buildinstall

; get entry index
set entryfilelc "`tr [A-Z] [a-z] <T:_entryfile`"
echo "$entryfilelc" >T:_entryfilelc
cut -c 1-1 T:_entryfilelc >T:_entryindex
set entryindex "`sed "2q;d" "T:_entryindex"`"

; write entry index progress, if different from current entry index and update current entry index
IF NOT "$currententryindex" EQ "$entryindex"
  echo "$entryindex..."
  set currententryindex "$entryindex"
ENDIF

; add entry to install script
echo "$entryfile" >>"SYS:T/_eab-whdload-install/install_$entryindex_$language_$hardware"


set entrylinenumber `eval $entrylinenumber + 1`

IF EXISTS "SYS:T/_eab-whdload-install/install_$entryindex_$language"
  search "SYS:T/_eab-whdload-install/install_$entryindex_$language" "_cdtv." >NIL:
ELSE
ENDIF

; echo "$entryfile" >>"SYS:T/_eab-whdload-install/install_$entryindex_$language_$hardware"





SKIP BACK nextentryfile


; End
; ---
LAB end

echo "Done."


Assign EABWHDLOADDIR: "PC:Commodore_Amiga_-_WHDLoad_-_Games" REMOVE
