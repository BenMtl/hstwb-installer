; Prepare Self Install
; --------------------
;
; Date: 2017-08-03
; Author: Henrik Noerfjand Stengaard
;
; An AmigaDOS script to prepare self install by detecting precense of CD drive, Amiga OS 3.9 iso and Boing Bags to configure installation flow.


; Clear screen
echo "*ec" 


echo "Device Names Overview"
echo "---------------------"
echo ""
echo "Using UAE emulator HstWB-Installer can detect and use"
echo "following device names for installation of Amiga OS 3.9,"
echo "Workbench 3.1 and Kickstart roms:"
echo "- CD0: CD drive with Amiga OS 3.9 CD-Rom."
echo "- OS39: Directory with Amiga 3.9 iso and boing bag files."
echo "  Note: Directory must be read/write, if installing Amiga"
echo "  OS 3.9 from iso (required by filedisk.device)."
echo "- WORKBENCHDIR: Directory with Workbench 3.1 adf files."
echo "- KICKSTARTDIR: Directory with Kickstart rom files."
echo ""
ask "Press ENTER to continue"


; Clear screen
echo "*ec" 


echo "Device Names Status"
echo "-------------------"
echo ""
echo "HstWB-Installer has detected device names with"
echo "following status:"


; Check if CD0: and AmigaOS3.9: device names exists and set installos39
set installos39 "0"
Assign >NIL: EXISTS CD0:
IF NOT WARN
  Assign >NIL: EXISTS AmigaOS3.9:
  IF NOT WARN
    set installos39 "1"
  ENDIF
ENDIF


; Print cd drive status depending on installos39
IF $installos39 EQ 1 VAL
  echo "- CD0: Present! Install Amiga OS 3.9 from CD drive."
ELSE
  echo "- CD0: Not present! Skip Amiga OS 3.9 installation"
  echo "  from CD drive."
ENDIF


; Check if OS39: device name and amiga os 3.9 iso exists and print message
set amigaos39isofile ""
Assign >NIL: EXISTS OS39:
IF NOT WARN
  ; Find boing bag files
  fsearch "OS39:" PAT BoingBag39#?.lha >T:_boingbagfiles1
  frsort <T:_boingbagfiles1 >T:_boingbagfiles

  IF $installos39 EQ 0 VAL
    ; Find amiga os 3.9 iso files
    echo "" NOLINE >T:_amigaos39isofiles
    fsearch "OS39:" PAT amigaos39.iso >>T:_amigaos39isofiles
    fsearch "OS39:" PAT amigaos3.9.iso >>T:_amigaos39isofiles

    ; Get first amiga os 3.9 iso file
    sed "1q;d" T:_amigaos39isofiles >T:_amigaos39isofile
    set amigaos39isofile "`type T:_amigaos39isofile`"
    IF NOT "$amigaos39isofile" EQ ""
      set installos39 "1"
      echo "- OS39: Present! Install Amiga OS 3.9 from iso and"
      echo "  apply Boing Bag updates."
    ELSE
      echo "- OS39: Present! Apply Boing Bag updates."
    ENDIF
  ELSE
    echo "- OS39: Present! Apply Boing Bag updates."
  ENDIF
ELSE
  echo "- OS39: Not present! Skip Amiga OS 3.9 installation"
  echo "  from iso and Boing Bag updates."
ENDIF


; Skip Workbench 3.1 installation, if Amiga OS 3.9 will be installed
IF $installos39 EQ 1 VAL
  echo "- WORKBENCHDIR: Ignored! Skip Workbench 3.1 installation,"
ELSE
  ; Create install workbench prefs
  echo "" >INSTALL:Prefs/Install-Workbench

  ; Check if WORKBENCHDIR: device name exists and print message
  Assign >NIL: EXISTS WORKBENCHDIR:
  IF NOT WARN
    echo "- WORKBENCHDIR: Present! Install Workbench 3.1 from adf."
  ELSE
    echo "- WORKBENCHDIR: Not present! Skip Workbench 3.1 installation"
    echo "  from adf and install Workbench 3.1 from disks."
  ENDIF
ENDIF


; Check if KICKSTARTDIR: device name exists and print message
Assign >NIL: EXISTS KICKSTARTDIR:
IF NOT WARN
  ; Create install kickstart prefs
  echo "" >INSTALL:Prefs/Install-Kickstart

  echo "- KICKSTARTDIR: Present! Install Kickstart rom files."
ELSE
  echo "- KICKSTARTDIR: Not present! Skip Kickstart rom installation."
ENDIF


; Create backup of mountlist, if it doesn't exist. Otherwise overwrite mountlist with backup.
IF NOT EXISTS INSTALL:Devs/Mountlist.bak
  Copy >NIL: INSTALL:Devs/Mountlist INSTALL:Devs/Mountlist.bak
ELSE
  Copy >NIL: INSTALL:Devs/Mountlist.bak INSTALL:Devs/Mountlist
ENDIF


; Replace os39isofilename placeholder in mountlist 
IF NOT "$amigaos39isofile" EQ ""
  rep INSTALL:Devs/Mountlist "OS39:[*$OS39IsoFileName]" "$amigaos39isofile"
ELSE
  rep INSTALL:Devs/Mountlist "OS39:[*$OS39IsoFileName]" ""
ENDIF


; Install amiga os 3.9, if installos39 is 1
IF $installos39 EQ 1 VAL 
  ; Create install amiga os 3.9 prefs, if installos39 is 1
  echo "" >INSTALL:Prefs/Install-AmigaOS3.9

  ; Print amiga os 3.9 iso file, if present
  IF NOT "$amigaos39isofile" EQ ""
    echo ""
    echo "Using Amiga OS 3.9 iso file:"
    echo "$amigaos39isofile"
  ENDIF

  ; Examine if boing bag files exists
  IF EXISTS T:_boingbagfiles
    set boingbagfilescount `wc -l <T:_boingbagfiles`

    ; Install boing bags, if one or more boing bag files exists
    echo ""
    IF $boingbagfilescount gt 0 VAL
      ; Create install boing bags prefs
      echo "" >INSTALL:Prefs/Install-BoingBags

      ; Print boing bag files
      echo "Using Boing Bag file(s):"
      type T:_boingbagfiles
    ELSE
      echo "Boing Bag file(s) doesn't exist. Skip Boing Bags"
      echo "installation."
    ENDIF
  ENDIF
ENDIF


echo ""
ask "Press ENTER to continue"