.KEY userpackages/a,installuserpackages/a
.BRA {
.KET }

; Prepare User Packages
; ---------------------
;
; Date: 2017-09-24
; Author: Henrik Noerfjand Stengaard

set menuindex 1

echo "; Install User Packages" >"{installuserpackages}"
echo "; ---------------------" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
;echo "; Date: ?" >>"{installuserpackages}"
echo "; Author: Henrik Noerfjand Stengaard" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "SKIP main" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
IF NOT EXISTS "PACKAGESDIR:SelectAssignDir"
  echo "Error: Select assign dir file 'PACKAGESDIR:SelectAssignDir' doesn't exist!"
  quit 20
ENDIF  
type "PACKAGESDIR:SelectAssignDir" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "; Main" >>"{installuserpackages}"
echo "LAB main" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "; Copy reqtools prefs to env, if it doesn't exist" >>"{installuserpackages}"
echo "IF NOT EXISTS *"ENV:ReqTools.prefs*"" >>"{installuserpackages}"
echo "  copy >NIL: *"ReqTools.prefs*" *"ENV:*"" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

; Create empty partial files for menus
echo "" NOLINE >T:_userpackagesmenu
echo "" NOLINE >T:_userpackagesoptions
echo "" NOLINE >T:_editassignsmenu
echo "" NOLINE >T:_editassignsoptions
echo "" NOLINE >T:_resetassigns
echo "" NOLINE >T:_defaultassigns
echo "" NOLINE >T:_validateassigns
echo "" NOLINE >T:_installuserpackages

; Get next user package from user packages file
LAB nextuserpackage
set userpackage ""
set userpackage "`FirstLine "{userpackages}" DELETE`"

; Goto end, if userpackage is empty
IF "$userpackage" EQ ""
  SKIP buildoptions
ENDIF

; Make package id
echo "$userpackage" >T:_packageid
set packageid "`md5sum2 <T:_packageid`"

; Build user packages reset
echo "" >>"{installuserpackages}"
echo "; User packages menu reset '$userpackage'" >>"{installuserpackages}"
echo "IF EXISTS *"T:$packageid*"" >>"{installuserpackages}"
echo "  delete >NIL: *"T:$packageid*"" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

; Build user packages menu
echo "" >>T:_userpackagesmenu
echo "; User packages menu '$userpackage' menu" >>T:_userpackagesmenu
echo "echo *"$userpackage : *" NOLINE >>T:userpackagesmenu" >>T:_userpackagesmenu
echo "IF EXISTS *"T:$packageid*"" >>T:_userpackagesmenu
echo "  echo *"YES*" >>T:userpackagesmenu" >>T:_userpackagesmenu
echo "ELSE" >>T:_userpackagesmenu
echo "  echo *"NO *" >>T:userpackagesmenu" >>T:_userpackagesmenu
echo "ENDIF" >>T:_userpackagesmenu

; Build user packages options
echo "" >>T:_userpackagesoptions
echo "; User package option '$userpackage' " >>T:_userpackagesoptions
echo "IF *"*$userpackagesmenu*" eq *"$menuindex*"" >>T:_userpackagesoptions
echo "  IF EXISTS *"T:$packageid*"" >>T:_userpackagesoptions
echo "    delete >NIL: *"T:$packageid*"" >>T:_userpackagesoptions
echo "  ELSE" >>T:_userpackagesoptions
echo "    echo *"*" NOLINE >*"T:$packageid*"" >>T:_userpackagesoptions
echo "  ENDIF" >>T:_userpackagesoptions
echo "ENDIF" >>T:_userpackagesoptions

; Make assign id
echo "$userpackage.InstallDir" >T:_assignid
set assignid "`md5sum2 <T:_assignid`"

; Get user package install dir
set installdir ""
IF EXISTS "USERPACKAGESDIR:$userpackage/_installdir"
  set installdir "`type "USERPACKAGESDIR:$userpackage/_installdir"`"
ENDIF

; Build edit assigns menu
echo "" >>T:_editassignsmenu
echo "; Edit assigns menu '$userpackage'" >>T:_editassignsmenu
echo "echo *"| $userpackage |*" >>T:editassignsmenu" >>T:_editassignsmenu
echo "IF EXISTS *"T:$assignid*"" >>T:_editassignsmenu
echo "  set installdir *"*`type *"T:$assignid*"*`*"" >>T:_editassignsmenu
echo "ELSE" >>T:_editassignsmenu
echo "  set installdir *"*"" >>T:_editassignsmenu
echo "ENDIF" >>T:_editassignsmenu
echo "IF NOT *"*$installdir*" EQ *"*"" >>T:_editassignsmenu
echo "  echo *"InstallDir: = '*$installdir'*" >>T:editassignsmenu" >>T:_editassignsmenu
echo "ELSE" >>T:_editassignsmenu
echo "  echo *"InstallDir: = ?*" >>T:editassignsmenu" >>T:_editassignsmenu
echo "ENDIF" >>T:_editassignsmenu

; Build edit assigns options
echo "" >>T:_editassignsoptions
echo "; Edit assigns option '$userpackage' " >>T:_editassignsoptions
set assignmenuindex `eval $menuindex * 2`
echo "IF *"*$editassignsmenu*" eq *"$assignmenuindex*"" >>T:_editassignsoptions
echo "  set assignid *"$assignid*"" >>T:_editassignsoptions
echo "  set assignname *"InstallDir*"" >>T:_editassignsoptions
echo "  IF NOT EXISTS *"T:$assignid*"" >>T:_editassignsoptions
echo "    echo *"Error: Assign file 'T:$assignid' doesn't exist!*"" >>T:_editassignsoptions
echo "    quit 20" >>T:_editassignsoptions
echo "  ENDIF" >>T:_editassignsoptions
echo "  set assigndir *"*`type *"T:$assignid*"*`*"" >>T:_editassignsoptions
echo "  set returnlab *"editassignsmenu*"" >>T:_editassignsoptions
echo "  SKIP BACK selectassigndir" >>T:_editassignsoptions
echo "ENDIF" >>T:_editassignsoptions

; Build reset assigns
echo "" >>T:_resetassigns
echo "; Reset assigns '$userpackage' " >>T:_resetassigns
echo "set installdir *"*"" >>T:_resetassigns
echo "set installdir *"*`Execute PACKAGESDIR:IniFileGet *"SYS:Prefs/Env-Archive/HstWB-Installer.Assigns.ini*" *"$userpackage*" *"InstallDir*"*`*"" >>T:_resetassigns
echo "" >>T:_resetassigns
echo "IF *"*$installdir*" EQ *"*"" >>T:_resetassigns
echo "  IF EXISTS *"USERPACKAGESDIR:$userpackage/_installdir*"" >>T:_resetassigns
echo "    set installdir *"*`type *"USERPACKAGESDIR:$userpackage/_installdir*"*`*"" >>T:_resetassigns
echo "  ENDIF" >>T:_resetassigns
echo "ENDIF" >>T:_resetassigns
echo "echo *"*$installdir*" >T:_installdir" >>T:_resetassigns
echo "rep T:_installdir *":*" *"**N*"" >>T:_resetassigns
echo "set devicename *"*`sed *"1q;d*" T:_installdir*`*"" >>T:_resetassigns
echo "Assign >NIL: EXISTS *"*$devicename:*"" >>T:_resetassigns
echo "IF WARN" >>T:_resetassigns
echo "  set installdir *"*"" >>T:_resetassigns
echo "ELSE" >>T:_resetassigns
echo "  IF NOT EXISTS *"*$installdir*"" >>T:_resetassigns
echo "    set installdir *"*"" >>T:_resetassigns
echo "  ENDIF" >>T:_resetassigns
echo "ENDIF" >>T:_resetassigns
echo "echo *"*$installdir*" NOLINE >*"T:$assignid*"" >>T:_resetassigns

; Build default assigns
echo "" >>T:_defaultassigns
echo "; Default assigns '$userpackage' " >>T:_defaultassigns
echo "set installdir *"*"" >>T:_defaultassigns
echo "IF EXISTS *"USERPACKAGESDIR:$userpackage/_installdir*"" >>T:_defaultassigns
echo "  set installdir *"*`type *"USERPACKAGESDIR:$userpackage/_installdir*"*`*"" >>T:_defaultassigns
echo "ENDIF" >>T:_defaultassigns
echo "echo *"*$installdir*" >T:_installdir" >>T:_defaultassigns
echo "rep T:_installdir *":*" *"**N*"" >>T:_defaultassigns
echo "set devicename *"*`sed *"1q;d*" T:_installdir*`*"" >>T:_defaultassigns
echo "Assign >NIL: EXISTS *"*$devicename:*"" >>T:_defaultassigns
echo "IF WARN" >>T:_defaultassigns
echo "  set installdir *"*"" >>T:_defaultassigns
echo "ELSE" >>T:_defaultassigns
echo "  IF NOT EXISTS *"*$installdir*"" >>T:_defaultassigns
echo "    set installdir *"*"" >>T:_defaultassigns
echo "  ENDIF" >>T:_defaultassigns
echo "ENDIF" >>T:_defaultassigns
echo "echo *"*$installdir*" NOLINE >*"T:$assignid*"" >>T:_defaultassigns

; Build validate assigns
echo "" >>T:_validateassigns
echo "; Validate assigns '$userpackage' " >>T:_validateassigns
echo "IF NOT EXISTS *"T:$assignid*"" >>T:_validateassigns
echo "  echo *"Error: Assign file 'T:$assignid' doesn't exist!*"" >>T:_validateassigns
echo "  quit 20" >>T:_validateassigns
echo "ENDIF" >>T:_validateassigns
echo "set installdir *"*`type *"T:$assignid*"*`*"" >>T:_validateassigns
echo "IF *"*$installdir*" EQ *"*"" >>T:_validateassigns
echo "  REQUESTCHOICE >NIL: *"Error*" *"Installdir is not defined**Nfor user package '$userpackage'!*" *"OK*"" >>T:_validateassigns
echo "  SKIP BACK userpackagesmenu" >>T:_validateassigns
echo "ENDIF" >>T:_validateassigns
echo "; Get device name from installdir by replacing colon with newline and get 1st line with device name" >>T:_validateassigns
echo "echo *"*$installdir*" >T:_installdir" >>T:_validateassigns
echo "rep T:_installdir *":*" *"**N*"" >>T:_validateassigns
echo "set devicename *"*`sed *"1q;d*" T:_installdir*`*"" >>T:_validateassigns
echo "Assign >NIL: EXISTS *"*$devicename:*"" >>T:_validateassigns
echo "IF WARN" >>T:_validateassigns
echo "  REQUESTCHOICE  >NIL: *"Error*" *"Device name '*$devicename:' in Installdir '*$installdir' doesn't exist**Nfor user package '$userpackage'!*" *"OK*"" >>T:_validateassigns
echo "  SKIP BACK userpackagesmenu" >>T:_validateassigns
echo "ENDIF" >>T:_validateassigns
echo "IF NOT EXISTS *"*$installdir*"" >>T:_validateassigns
echo "  REQUESTCHOICE  >NIL: *"Error*" *"Installdir '*$installdir' doesn't exist**Nfor user package '$userpackage'!*" *"OK*"" >>T:_validateassigns
echo "  SKIP BACK userpackagesmenu" >>T:_validateassigns
echo "ENDIF" >>T:_validateassigns

; Build install user packages
echo "" >>T:_installuserpackages
echo "; Install user package '$userpackage'" >>T:_installuserpackages
echo "IF EXISTS *"T:$packageid*"" >>T:_installuserpackages
echo "  echo *"*"" >>T:_installuserpackages
echo "  echo *"User Package '$userpackage'*"" >>T:_installuserpackages
echo "  echo *"*"" >>T:_installuserpackages
echo "  IF NOT EXISTS *"T:$assignid*"" >>T:_installuserpackages
echo "    echo *"Error: Assign file 'T:$assignid' doesn't exist!*"" >>T:_installuserpackages
echo "    quit 20" >>T:_installuserpackages
echo "  ENDIF" >>T:_installuserpackages
echo "  set installdir *"*`type *"T:$assignid*"*`*"" >>T:_installuserpackages
echo "  MakePath *"SYS:Prefs*/Env-Archive*"" >>T:_installuserpackages
echo "  Execute PACKAGESDIR:IniFileSet *"SYS:Prefs/Env-Archive/HstWB-Installer.Assigns.ini*" *"$userpackage*" *"InstallDir*" *"*$installdir*"" >>T:_installuserpackages
echo "  echo *"Installing '$userpackage' to '*$installdir'...*"" >>T:_installuserpackages
echo "  MakePath *"*$installdir*"" >>T:_installuserpackages
echo "  Assign USERPACKAGEDIR: *"USERPACKAGESDIR:$userpackage*"" >>T:_installuserpackages
echo "  IF EXISTS *"USERPACKAGESDIR:$userpackage*/_install*"" >>T:_installuserpackages
echo "    Execute *"USERPACKAGESDIR:$userpackage*/_install*"" >>T:_installuserpackages
echo "  ELSE" >>T:_installuserpackages
echo "    Copy >NIL: *"USERPACKAGESDIR:$userpackage*" *"*$installdir*" ALL" >>T:_installuserpackages
echo "    IF EXISTS *"*$installdir/_installdir*"" >>T:_installuserpackages
echo "      Delete >NIL: *"*$installdir/_installdir*"" >>T:_installuserpackages
echo "    ENDIF" >>T:_installuserpackages
echo "  ENDIF" >>T:_installuserpackages
echo "  Assign USERPACKAGEDIR: *"USERPACKAGESDIR:$userpackage*" REMOVE" >>T:_installuserpackages
echo "  echo *"Done*"" >>T:_installuserpackages
echo "ENDIF" >>T:_installuserpackages

set menuindex `eval $menuindex + 1`

SKIP BACK nextuserpackage


; Build user packages options
; ---------------------------
LAB buildoptions

type T:_resetassigns >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "SKIP userpackagesmenu" >>"{installuserpackages}"

echo "" >>"{installuserpackages}"
echo "; Reset assigns" >>"{installuserpackages}"
echo "LAB resetassigns" >>"{installuserpackages}"

type T:_resetassigns >>"{installuserpackages}"
Delete >NIL: T:_resetassigns

echo "" >>"{installuserpackages}"
echo "SKIP editassignsmenu" >>"{installuserpackages}"

; Default assigns
; ---------------
echo "" >>"{installuserpackages}"
echo "; Default assigns" >>"{installuserpackages}"
echo "LAB defaultassigns" >>"{installuserpackages}"

type T:_defaultassigns >>"{installuserpackages}"
Delete >NIL: T:_defaultassigns

echo "" >>"{installuserpackages}"
echo "SKIP editassignsmenu" >>"{installuserpackages}"

echo "" >>"{installuserpackages}"
echo "; User packages menu" >>"{installuserpackages}"
echo "LAB userpackagesmenu" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "echo *"*" NOLINE >T:userpackagesmenu" >>"{installuserpackages}"

type T:_userpackagesmenu >>"{installuserpackages}"
Delete >NIL: T:_userpackagesmenu

echo "echo *"========================================*" >>T:userpackagesmenu" >>"{installuserpackages}"
echo "echo *"Edit assigns*" >>T:userpackagesmenu" >>"{installuserpackages}"
echo "echo *"Install user packages*" >>T:userpackagesmenu" >>"{installuserpackages}"
echo "echo *"Skip user packages*" >>T:userpackagesmenu" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "set userpackagesmenu *"*"" >>"{installuserpackages}"
echo "set userpackagesmenu *"*`ReqList CLONERT I=T:userpackagesmenu H=*"Select user packages to install*" PAGE=18*`*"" >>"{installuserpackages}"
echo "Delete >NIL: T:userpackagesmenu" >>"{installuserpackages}"

type T:_userpackagesoptions >>"{installuserpackages}"
Delete >NIL: T:_userpackagesoptions

set menuoption `eval $menuindex + 1`
echo "" >>"{installuserpackages}"
echo "; Edit assigns option" >>"{installuserpackages}"
echo "IF *"*$userpackagesmenu*" eq *"$menuoption*"" >>"{installuserpackages}"
echo "  SKIP editassignsmenu" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

set menuoption `eval $menuindex + 2`
echo "" >>"{installuserpackages}"
echo "; Install user packages option" >>"{installuserpackages}"
echo "IF *"*$userpackagesmenu*" eq *"$menuoption*"" >>"{installuserpackages}"
echo "  set confirm *`RequestChoice *"Confirm*" *"Do you want to install selected user packages?*" *"Yes|No*"*`" >>"{installuserpackages}"
echo "  IF *"*$confirm*" EQ *"1*"" >>"{installuserpackages}"
echo "    SKIP installuserpackages" >>"{installuserpackages}"
echo "  ENDIF" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

set menuoption `eval $menuindex + 3`
echo "" >>"{installuserpackages}"
echo "; Skip user packages option" >>"{installuserpackages}"
echo "IF *"*$userpackagesmenu*" eq *"$menuoption*"" >>"{installuserpackages}"
echo "  set confirm *`RequestChoice *"Confirm*" *"Do you want to skip user packages installation?*" *"Yes|No*"*`" >>"{installuserpackages}"
echo "  IF *"*$confirm*" EQ *"1*"" >>"{installuserpackages}"
echo "    SKIP end" >>"{installuserpackages}"
echo "  ENDIF" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

echo "" >>"{installuserpackages}"
echo "SKIP BACK userpackagesmenu" >>"{installuserpackages}"


; Edit assigns menu
; -----------------
echo "" >>"{installuserpackages}"
echo "; Edit assigns menu" >>"{installuserpackages}"
echo "LAB editassignsmenu" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "echo *"*" NOLINE >T:editassignsmenu" >>"{installuserpackages}"

type T:_editassignsmenu >>"{installuserpackages}"
Delete >NIL: T:_editassignsmenu

echo "echo *"========================================*" >>T:editassignsmenu" >>"{installuserpackages}"
echo "echo *"Reset assigns*" >>T:editassignsmenu" >>"{installuserpackages}"
echo "echo *"Default assigns*" >>T:editassignsmenu" >>"{installuserpackages}"
echo "echo *"Back*" >>T:editassignsmenu" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "set editassignsmenu *"*"" >>"{installuserpackages}"
echo "set editassignsmenu *"*`ReqList CLONERT I=T:editassignsmenu H=*"Edit assigns*" PAGE=18*`*"" >>"{installuserpackages}"
echo "Delete >NIL: T:editassignsmenu" >>"{installuserpackages}"

type T:_editassignsoptions >>"{installuserpackages}"
Delete >NIL: T:_editassignsoptions

set menuoption `eval ($menuindex * 2)`
echo "" >>"{installuserpackages}"
echo "; Reset assigns option" >>"{installuserpackages}"
echo "IF *"*$editassignsmenu*" eq *"$menuoption*"" >>"{installuserpackages}"
echo "  set confirm *`RequestChoice *"Confirm*" *"Do you want to reset assigns?*" *"Yes|No*"*`" >>"{installuserpackages}"
echo "  IF *"*$confirm*" EQ *"1*"" >>"{installuserpackages}"
echo "    SKIP BACK resetassigns" >>"{installuserpackages}"
echo "  ENDIF" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

set menuoption `eval ($menuindex * 2) + 1`
echo "" >>"{installuserpackages}"
echo "; Default assigns option" >>"{installuserpackages}"
echo "IF *"*$editassignsmenu*" eq *"$menuoption*"" >>"{installuserpackages}"
echo "  set confirm *`RequestChoice *"Confirm*" *"Do you want to use default assigns?*" *"Yes|No*"*`" >>"{installuserpackages}"
echo "  IF *"*$confirm*" EQ *"1*"" >>"{installuserpackages}"
echo "    SKIP BACK defaultassigns" >>"{installuserpackages}"
echo "  ENDIF" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

set menuoption `eval ($menuindex * 2) + 2`
echo "" >>"{installuserpackages}"
echo "; Back option" >>"{installuserpackages}"
echo "IF *"*$editassignsmenu*" eq *"$menuoption*"" >>"{installuserpackages}"
echo "  SKIP BACK userpackagesmenu" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

echo "" >>"{installuserpackages}"
echo "SKIP BACK editassignsmenu" >>"{installuserpackages}"


; Install user packages
; ---------------------

echo "" >>"{installuserpackages}"
echo "; Install user packages" >>"{installuserpackages}"
echo "LAB installuserpackages" >>"{installuserpackages}"

type T:_validateassigns >>"{installuserpackages}"
Delete >NIL: T:_validateassigns

echo "" >>"{installuserpackages}"
echo "echo *"**ec*" NOLINE" >>"{installuserpackages}"
echo "echo *"User Package Installation*"" >>"{installuserpackages}"
echo "echo *"-------------------------*"" >>"{installuserpackages}"

type T:_installuserpackages >>"{installuserpackages}"
Delete >NIL: T:_installuserpackages

echo "echo *"*"" >>"{installuserpackages}"
echo "echo *"User package installation is complete.*"" >>"{installuserpackages}"
echo "echo *"*"" >>"{installuserpackages}"
echo "ask *"Press ENTER to continue*"" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "; End" >>"{installuserpackages}"
echo "LAB end" >>"{installuserpackages}"