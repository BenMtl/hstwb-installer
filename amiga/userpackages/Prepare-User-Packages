.KEY userpackages/a,installuserpackages/a
.BRA {
.KET }

; Prepare User Packages
; ---------------------
;
; Date: 2017-09-23
; Author: Henrik Noerfjand Stengaard

set userpackageoption 1

echo "; Install User Packages" >"{installuserpackages}"
echo "; ---------------------" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
;echo "; Date: ?" >>"{installuserpackages}"
echo "; Author: Henrik Noerfjand Stengaard" >>"{installuserpackages}"

; Create empty install user packages menu file
echo "" NOLINE >T:_userpackagesoptions
echo "" NOLINE >T:_installuserpackages

; Get next user package from user packages file
LAB nextuserpackage
set userpackage ""
set userpackage "`FirstLine "{userpackages}" DELETE`"

; Goto end, if userpackage is empty
IF "$userpackage" EQ ""
  SKIP buildoptions
ENDIF

; Make package id
echo "$userpackage" >T:_packageid
set packageid "`md5sum2 <T:_packageid`"

; Build user packages reset
echo "" >>"{installuserpackages}"
echo "; '$userpackage' reset" >>"{installuserpackages}"
echo "IF EXISTS *"T:$packageid*"" >>"{installuserpackages}"
echo "  delete >NIL: *"T:$packageid*"" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

; Build user packages menu
echo "" >>T:_userpackagesmenu
echo "; '$userpackage' menu" >>T:_userpackagesmenu
echo "echo *"$userpackage : *" NOLINE >>T:userpackagesmenu" >>T:_userpackagesmenu
echo "IF EXISTS *"T:$packageid*"" >>T:_userpackagesmenu
echo "  echo *"YES*" >>T:userpackagesmenu" >>T:_userpackagesmenu
echo "ELSE" >>T:_userpackagesmenu
echo "  echo *"NO *" >>T:userpackagesmenu" >>T:_userpackagesmenu
echo "ENDIF" >>T:_userpackagesmenu

; Build user packages options
echo "" >>T:_userpackagesoptions
echo "; '$userpackage' option" >>T:_userpackagesoptions
echo "IF *"*$userpackagesmenu*" eq *"$userpackageoption*"" >>T:_userpackagesoptions
echo "  IF EXISTS *"T:$packageid*"" >>T:_userpackagesoptions
echo "    delete >NIL: *"T:$packageid*"" >>T:_userpackagesoptions
echo "  ELSE" >>T:_userpackagesoptions
echo "    echo *"*" NOLINE >*"T:$packageid*"" >>T:_userpackagesoptions
echo "  ENDIF" >>T:_userpackagesoptions
echo "ENDIF" >>T:_userpackagesoptions

; Build install user packages
echo "" >>T:_installuserpackages
echo "; Install user package '$userpackage'" >>T:_installuserpackages
echo "IF EXISTS *"T:$packageid*"" >>T:_installuserpackages
echo "  echo *"*"" >>T:_installuserpackages
echo "  echo *"User Package '$userpackage'*"" >>T:_installuserpackages
echo "  echo *"*"" >>T:_installuserpackages

; Make assign id
echo "$userpackage.TargetDir" >T:_assignid
set assignid "`md5sum2 <T:_assignid`"

; Get user package install dir
set installdir ""
IF EXISTS "USERPACKAGESDIR:$userpackage/_installdir"
  set installdir "`type "USERPACKAGESDIR:$userpackage/_installdir"`"
ENDIF

; Build install user packages
echo "  IF EXISTS *"T:$assignid*"" >>T:_installuserpackages
echo "    Set installdir *"*`type *"T:$assignid*"*`*"" >>T:_installuserpackages
echo "  ELSE" >>T:_installuserpackages
echo "    Set installdir *"$installdir*"" >>T:_installuserpackages
echo "  ENDIF" >>T:_installuserpackages
echo "  MakePath *"SYS:Prefs*/Env-Archive*"" >>T:_installuserpackages
echo "  Execute PACKAGESDIR:IniFileSet *"SYS:Prefs/Env-Archive/HstWB-Installer.Assigns.ini*" *"$userpackage*" *"InstallDir*" *"*$installdir*"" >>T:_installuserpackages
echo "  echo *"Installing...*"" >>T:_installuserpackages
echo "  MakePath *"*$installdir*"" >>T:_installuserpackages
echo "  IF EXISTS *"USERPACKAGESDIR:$userpackage*/_install*"" >>T:_installuserpackages
echo "    Execute *"USERPACKAGESDIR:$userpackage*/_install*"" >>T:_installuserpackages
echo "  ELSE" >>T:_installuserpackages
echo "    Copy >NIL: *"USERPACKAGESDIR:$userpackage*" *"*$installdir*" ALL" >>T:_installuserpackages
echo "  ENDIF" >>T:_installuserpackages
echo "  echo *"Done*"" >>T:_installuserpackages
echo "ENDIF" >>T:_installuserpackages

set userpackageoption `eval $userpackageoption + 1`

SKIP BACK nextuserpackage


; Build user packages options
; ---------------------------
LAB buildoptions

echo "" >>"{installuserpackages}"
echo "; User packages menu" >>"{installuserpackages}"
echo "LAB userpackagesmenu" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "echo *"*" NOLINE >T:userpackagesmenu" >>"{installuserpackages}"

type T:_userpackagesmenu >>"{installuserpackages}"
Delete >NIL: T:_userpackagesmenu

echo "echo *"========================================*" >>T:userpackagesmenu" >>"{installuserpackages}"
echo "echo *"Edit assigns*" >>T:userpackagesmenu" >>"{installuserpackages}"
echo "echo *"Install user packages*" >>T:userpackagesmenu" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "set userpackagesmenu *"*"" >>"{installuserpackages}"
echo "set userpackagesmenu *"*`ReqList CLONERT I=T:userpackagesmenu H=*"Select user packages to install*" PAGE=18*`*"" >>"{installuserpackages}"
echo "Delete >NIL: T:userpackagesmenu" >>"{installuserpackages}"

type T:_userpackagesoptions >>"{installuserpackages}"
Delete >NIL: T:_userpackagesoptions

set userpackageoption `eval $userpackageoption + 1`
echo "" >>"{installuserpackages}"
echo "; Edit assigns option" >>"{installuserpackages}"
echo "IF *"*$userpackagesmenu*" eq *"$userpackageoption*"" >>"{installuserpackages}"
echo "  SKIP editassignsmenu" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

set userpackageoption `eval $userpackageoption + 1`
echo "" >>"{installuserpackages}"
echo "; Install user packages option" >>"{installuserpackages}"
echo "IF *"*$userpackagesmenu*" eq *"$userpackageoption*"" >>"{installuserpackages}"
echo "  SKIP installuserpackages" >>"{installuserpackages}"
echo "ENDIF" >>"{installuserpackages}"

echo "" >>"{installuserpackages}"
echo "SKIP BACK userpackagesmenu" >>"{installuserpackages}"

; edit assigns menu
echo "" >>"{installuserpackages}"
echo "; Edit assigns menu" >>"{installuserpackages}"
echo "LAB editassignsmenu" >>"{installuserpackages}"
echo "SKIP end" >>"{installuserpackages}"

; install user packages
echo "" >>"{installuserpackages}"
echo "; Install user packages" >>"{installuserpackages}"
echo "LAB installuserpackages" >>"{installuserpackages}"
echo "echo *"**ec*" NOLINE" >>"{installuserpackages}"
echo "echo *"User Package Installation*"" >>"{installuserpackages}"
echo "echo *"-------------------------*"" >>"{installuserpackages}"

type T:_installuserpackages >>"{installuserpackages}"
Delete >NIL: T:_installuserpackages

echo "echo *"*"" >>"{installuserpackages}"
echo "echo *"User package installation is complete.*"" >>"{installuserpackages}"
echo "echo *"*"" >>"{installuserpackages}"
echo "ask *"Press ENTER to continue*"" >>"{installuserpackages}"
echo "" >>"{installuserpackages}"
echo "; End" >>"{installuserpackages}"
echo "LAB end" >>"{installuserpackages}"