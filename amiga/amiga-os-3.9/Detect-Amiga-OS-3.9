; Detect Amiga OS 3.1.4 Adf
; -------------------------
;
; Date: 2018-11-07
; Author: Henrik Noerfjand Stengaard
;
; AmigaDOS script to detect if Amiga OS 3.9 cd-rom, iso and Boing Bag lha files are present.


; set amigaos39 to 1
set amigaos39 "1"


; set fail at 255 for DiskInDrive to fail silently
failat 255


; set amigaos39 to 0, if device CD0: doesn't contain a cd-rom
DiskInDrive >NIL: CD0:
IF WARN
  set amigaos39 "0"
ENDIF


; Set fail at 21
failat 21


; Check if CD0: and AmigaOS3.9: device names exists and set amigaos39
IF $amigaos39 EQ 1 VAL
  Assign >NIL: EXISTS AmigaOS3.9:
  IF WARN
    set amigaos39 "0"
  ENDIF
ENDIF


; Print cd drive status depending on amigaos39
IF $amigaos39 EQ 1 VAL
  echo "- *e[1mCD0*e[0m: Present! Install Amiga OS 3.9 from CD drive."
ELSE
  echo "- *e[1mCD0*e[0m: Not present! Skip Amiga OS 3.9 installation"
  echo "  from CD drive."
ENDIF


; set amigaosdir to 1, if device name AMIGAOSDIR: exists
set amigaosdir "0"
Assign >NIL: EXISTS AMIGAOSDIR:
IF NOT WARN
  ; Set fail at 255 for DiskInDrive to fail silently
  failat 255

  ; set amigaosdir to 1, if device AMIGAOSDIR: is mapped to a directory
  DiskInDrive >NIL: AMIGAOSDIR:
  IF NOT WARN
    set amigaosdir "1"
  ENDIF

  ; Set fail at 21
  failat 21
ENDIF


; find amiga os 3.9 iso, if not installing amiga os 3.9 from cd-drive
IF $amigaos39 EQ 0 VAL
    ; Find amiga os 3.9 iso files
    echo "" NOLINE >T:_amigaos39isofiles
    fsearch "AMIGAOSDIR:" PAT amigaos3.9.iso >>T:_amigaos39isofiles

    ; get first amiga os 3.9 iso file
    sed "1q;d" T:_amigaos39isofiles >T:_amigaos39isofile
    set amigaos39isofile "`type T:_amigaos39isofile`"
    IF NOT "$amigaos39isofile" EQ ""
        set amigaos39 "1"
    ENDIF
ENDIF



; find and sort boing bag files
fsearch "AMIGAOSDIR:" PAT BoingBag39#?.lha >T:_boingbagfiles1
frsort <T:_boingbagfiles1 >T:_boingbagfiles

; set install boing bags
set installboingbags `wc -l <T:_boingbagfiles` 

ENDIF

; print amigaosdir installation status
IF $amigaos39 EQ 1 VAL
IF NOT $installboingbags EQ 0 VAL
    echo "- *e[1mAMIGAOSDIR*e[0m: Present! Install Amiga OS 3.9 from iso and"
    echo "  apply Boing Bag updates."
ELSE
    echo "- *e[1mAMIGAOSDIR*e[0m: Present! Install Amiga OS 3.9 from iso."
ENDIF
ELSE
echo "- *e[1mAMIGAOSDIR*e[0m: Present! Skip Amiga OS 3.9 installation"
echo "  from iso, Amiga OS 3.9 iso doesn't exist."
ENDIF
