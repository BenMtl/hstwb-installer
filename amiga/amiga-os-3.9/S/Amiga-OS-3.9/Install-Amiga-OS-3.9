; Install Amiga OS 3.9
; --------------------
;
; Date: 2018-12-23
; Author: Henrik Noerfjand Stengaard
;
; AmigsDOS script to automate installation of Amiga OS 3.9.
;
; References:
; https://modelrail.otenko.com/c64amiga/amiga-1200-installing-amigaos-3-9
; http://elite79.tripod.com/os39uae/
; http://os.amigaworld.de/index.php?lang=en&page=12


; Amiga OS 3.9 installation
cls 
echo "*e[32m" NOLINE
echo "Amiga OS 3.9 Installation"
echo "*e[0m*e[1m" NOLINE
echo "-------------------------"
echo "*e[0m" NOLINE
echo ""

; goto fail, if device AmigaOS3.9: doesn't exist
Assign >NIL: EXISTS AmigaOS3.9:
IF WARN
  echo "*e[1mERROR: Device AmigaOS3.9: doesn't exist!*e[22m"
  SKIP fail
ENDIF

; install amiga os 3.9 message
echo "*e[1mInstalling Amiga OS 3.9*e[0m"

; copy workbench
echo "Copying Workbench..."
Copy >NIL: AmigaOS3.9:OS-VERSION3.9/Workbench3.5 SYSTEMDIR: ALL
Copy >NIL: AmigaOS3.9:OS-VERSION3.9/Workbench3.9 SYSTEMDIR: ALL

; copy libs
echo "Copying Libs..."
Copy >NIL: AmigaOS3.9:OS-VERSION3.9/Extras/Libs/asyncio.library SYSTEMDIR:Libs

; copy backdrops (optional)
echo "Copying Backdrops..."
Copy >NIL: AmigaOS3.9:OS-VERSION3.9/Extras/Backdrops SYSTEMDIR:Prefs/Presets/Backdrops ALL

; copy locale
echo "Copying Locale..."
Copy >NIL: AmigaOS3.9:OS-VERSION3.9/LOCALE SYSTEMDIR:Locale ALL

; copy keymaps
echo "Copying keymaps..."
Copy >NIL: AmigaOS3.9:OS-VERSION3.9/Workbench3.9/Storage/Keymaps SYSTEMDIR:Devs/Keymaps

; copy 68040.library, if it doesn't exist
IF NOT EXISTS "SYSTEMDIR:Libs/68040.library"
  Copy >NIL: "AmigaOS3.9:OS-VERSION3.9/Extras/Libs/68040.library" SYSTEMDIR:Libs
ENDIF

; copy 68060.library, if it doesn't exist
IF NOT EXISTS "SYSTEMDIR:Libs/68060.library"
  Copy >NIL: "AmigaOS3.9:OS-VERSION3.9/Extras/Libs/68060.library" SYSTEMDIR:Libs
ENDIF

; rename fastfilesystem to old, if it exists
IF EXISTS "SYSTEMDIR:L/FastFileSystem"
  Version >NIL: "SYSTEMDIR:L/FastFileSystem" 40 FILE
  IF WARN
    Rename >NIL: "SYSTEMDIR:L/FastFileSystem" "SYSTEMDIR:L/FastFileSystem-old"
  ENDIF 
ENDIF 

; copy fastfilesystem
Copy >NIL: "AmigaOS3.9:OS-VERSION3.9/L/FastFileSystem" "SYSTEMDIR:L"

; fix fonts
echo "Fix fonts..."
Assign >NIL: Fonts: "SYSTEMDIR:Fonts"
SYSTEMDIR:System/FixFonts
Assign >NIL: Fonts: "SYSTEMDIR:Fonts" REMOVE

; copy prefs
Copy >NIL: "AmigaOS3.9:OS-VERSION3.9/EMERGENCY-DISK/PREFS/ENV-ARCHIVE/SYS/FONT.PREFS" "SYSTEMDIR:Prefs/Env-Archive/Sys"
Copy >NIL: "AmigaOS3.9:EMERGENCY-BOOT/PREFS/ENV-ARCHIVE/SYS/REACTION.PREFS" "SYSTEMDIR:Prefs/Env-Archive/Sys"
Copy >NIL: "AmigaOS3.9:EMERGENCY-BOOT/PREFS/ENV-ARCHIVE/SYS/WBCONFIG.PREFS" "SYSTEMDIR:Prefs/Env-Archive/Sys"
Copy >NIL: "AmigaOS3.9:EMERGENCY-BOOT/PREFS/ENV-ARCHIVE/SYS/WBPATTERN.PREFS" "SYSTEMDIR:Prefs/Env-Archive/Sys"
Copy >NIL: "AmigaOS3.9:EMERGENCY-BOOT/PREFS/ENV-ARCHIVE/SYS/WORKBENCH.PREFS" "SYSTEMDIR:Prefs/Env-Archive/Sys"

; copy uae prefs, if it exists in install
IF EXISTS INSTALLDIR:Prefs/UAE
  Copy >NIL: INSTALLDIR:Prefs/UAE SYSTEMDIR:Prefs
ENDIF

; cleanup
echo "Cleaning up..."
Resident >NIL: "AmigaOS3.9:OS-VERSION3.9/INSTALL-TOOLS/ICONPOS" PURE

ICONPOS >NIL: "SYSTEMDIR:Prefs"   10 220 DXPOS 50 DYPOS 50 DWIDTH 520 DHEIGHT 240
ICONPOS >NIL: "SYSTEMDIR:Prefs/Font"                       10 10
ICONPOS >NIL: "SYSTEMDIR:Prefs/Locale"                     80 10

;      (tooltype (dest (tackon target "Prefs/Locale")) (settooltype "MAP" "PROGDIR:WORLDMAP"))

ICONPOS >NIL: "SYSTEMDIR:Prefs/Pointer"                   150 10
ICONPOS >NIL: "SYSTEMDIR:Prefs/PrinterPS"                 220 10
ICONPOS >NIL: "SYSTEMDIR:Prefs/Sound"                     290 10
ICONPOS >NIL: "SYSTEMDIR:Prefs/ReAction"                  360 10
ICONPOS >NIL: "SYSTEMDIR:Prefs/IControl"                   10 80
ICONPOS >NIL: "SYSTEMDIR:Prefs/Overscan"                   80 80
ICONPOS >NIL: "SYSTEMDIR:Prefs/Printer"                   150 80
ICONPOS >NIL: "SYSTEMDIR:Prefs/ScreenMode"                220 80
ICONPOS >NIL: "SYSTEMDIR:Prefs/Time"                      290 80
ICONPOS >NIL: "SYSTEMDIR:Prefs/Workbench"                 360 80
ICONPOS >NIL: "SYSTEMDIR:Prefs/Input"                     10 150
ICONPOS >NIL: "SYSTEMDIR:Prefs/Palette"                   80 150
ICONPOS >NIL: "SYSTEMDIR:Prefs/PrinterGfx"               150 150
ICONPOS >NIL: "SYSTEMDIR:Prefs/Serial"                   220 150
ICONPOS >NIL: "SYSTEMDIR:Prefs/WBPattern"                290 150
ICONPOS >NIL: "SYSTEMDIR:Prefs/Presets"                  430 150
ICONPOS >NIL: "SYSTEMDIR:Prefs/CacheCDFS"                360 150

ICONPOS >NIL: "SYSTEMDIR:Utilities"      10 80 DXPOS 40 DYPOS 60 DWIDTH 180 DHEIGHT 100
ICONPOS >NIL: "SYSTEMDIR:Utilities/Clock"                  80 10
ICONPOS >NIL: "SYSTEMDIR:Utilities/MultiView"              10 10

ICONPOS >NIL: "SYSTEMDIR:Tools"          10 150 DXPOS 20 DYPOS 80 DWIDTH 290 DHEIGHT 300
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities"     10 10 DXPOS 80 DYPOS 60 DWIDTH 240 DHEIGHT 240
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/Exchange"       10 10
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/Blanker"        10 80
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/ClickToFront"   80 10
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/CrossDOS"       80 80
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/FKey"          150 10
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/AutoPoint"     10 150
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/NoCapsLock"    80 150
ICONPOS >NIL: "SYSTEMDIR:Tools/Commodities/MouseBlanker"  150 80

ICONPOS >NIL: "SYSTEMDIR:Tools/EditPad"                   80  10
ICONPOS >NIL: "SYSTEMDIR:Tools/IconEdit"                 150  10
ICONPOS >NIL: "SYSTEMDIR:Tools/PrepCard"                 220  10
ICONPOS >NIL: "SYSTEMDIR:Tools/Mounter"                   10  80
ICONPOS >NIL: "SYSTEMDIR:Tools/MEmacs"                    80  80
ICONPOS >NIL: "SYSTEMDIR:Tools/ShowConfig"               150  80
ICONPOS >NIL: "SYSTEMDIR:Tools/CMD"                      220  80
ICONPOS >NIL: "SYSTEMDIR:Tools/Calculator"                10 150
ICONPOS >NIL: "SYSTEMDIR:Tools/HDToolBox"                 80 150
ICONPOS >NIL: "SYSTEMDIR:Tools/KeyShow"                  150 150
ICONPOS >NIL: "SYSTEMDIR:Tools/Lacer"                    220 150
ICONPOS >NIL: "SYSTEMDIR:Tools/GraphicDump"               10 220
ICONPOS >NIL: "SYSTEMDIR:Tools/InitPrinter"               80 220
ICONPOS >NIL: "SYSTEMDIR:Tools/PrintFiles"               150 220
ICONPOS >NIL: "SYSTEMDIR:Tools/FindFile"                 220 220

ICONPOS >NIL: "SYSTEMDIR:System"    10 10 DXPOS 50 DYPOS 60 DWIDTH 240 DHEIGHT 180
ICONPOS >NIL: "SYSTEMDIR:System/FixFonts"                10 10
ICONPOS >NIL: "SYSTEMDIR:System/Format"                  80 10
ICONPOS >NIL: "SYSTEMDIR:System/NoFastMem"              150 10
ICONPOS >NIL: "SYSTEMDIR:System/RexxMast"                10 80
ICONPOS >NIL: "SYSTEMDIR:System/Shell"                   80 80
ICONPOS >NIL: "SYSTEMDIR:System/Intellifont"            150 80

ICONPOS >NIL: "SYSTEMDIR:Devs"      80 10 DXPOS 80 DYPOS 77 DWIDTH 180 DHEIGHT 230
ICONPOS >NIL: "SYSTEMDIR:Devs/Datatypes"                 10  10
ICONPOS >NIL: "SYSTEMDIR:Devs/DosDrivers"                10  80
ICONPOS >NIL: "SYSTEMDIR:Devs/KeyMaps"                   80  10
ICONPOS >NIL: "SYSTEMDIR:Devs/Monitors"                  80  80
ICONPOS >NIL: "SYSTEMDIR:Devs/Printers"                 10 150

ICONPOS >NIL: "SYSTEMDIR:Storage"              80  80 DXPOS 480 DYPOS 77 DWIDTH 180 DHEIGHT 230
ICONPOS >NIL: "SYSTEMDIR:Storage/Datatypes"    10  10 DXPOS 480 DYPOS 77 DWIDTH 107 DHEIGHT 199
ICONPOS >NIL: "SYSTEMDIR:Storage/DosDrivers"   10  80 DXPOS 480 DYPOS 77 DWIDTH 107 DHEIGHT 199
ICONPOS >NIL: "SYSTEMDIR:Storage/KeyMaps"      80  10 DXPOS 480 DYPOS 77 DWIDTH 107 DHEIGHT 199
ICONPOS >NIL: "SYSTEMDIR:Storage/Monitors"     80  80 DXPOS 480 DYPOS 77 DWIDTH 107 DHEIGHT 199
ICONPOS >NIL: "SYSTEMDIR:Storage/Printers"     10 150 DXPOS 480 DYPOS 77 DWIDTH 107 DHEIGHT 199

ICONPOS >NIL: "SYSTEMDIR:WBStartup" 80 220
ICONPOS >NIL: "SYSTEMDIR:Expansion" 80 150
ICONPOS >NIL: "SYSTEMDIR:Trashcan" 160 220
ICONPOS >NIL: "SYSTEMDIR:Disk"      DXPOS 50 DYPOS 50 DWIDTH 250 DHEIGHT 310

; copy pal or ntsc screenmode prefs
IF "$palmonitor" EQ 1 VAL
  Copy >NIL: INSTALLDIR:Extras/Amiga-OS-3.9/Prefs/ScreenMode_PAL_640x512.prefs SYSTEMDIR:Prefs/Env-Archive/Sys/ScreenMode.prefs
ELSE
  Copy >NIL: INSTALLDIR:Extras/Amiga-OS-3.9/Prefs/ScreenMode_NTSC_640x400.prefs SYSTEMDIR:Prefs/Env-Archive/Sys/ScreenMode.prefs
ENDIF

; copy install amiga os 3.9 to systemdir and update startup sequence to load patch scsi.device, if install amiga os 3.9 boing bags 1 prefs exist
IF EXISTS "INSTALLDIR:Prefs/Install-Amiga-OS-390-BB1"
  ; copy assign hstwb installer and amiga os 3.9 boing bags
  Copy >NIL: "INSTALLDIR:S/Assign-HstWB-Installer" "SYSTEMDIR:S"
  Copy >NIL: "INSTALLDIR:Extras/Amiga-OS-3.9/Boing-Bags/S" "SYSTEMDIR:S" ALL
  Copy >NIL: "INSTALLDIR:Extras/Amiga-OS-3.9/Boing-Bags/WBStartup" "SYSTEMDIR:WBStartup" ALL

  ; update startup sequence with loadmodule patched scsi.device
  echo "FailAt 21" >>T:Startup-Sequence
  echo "" >>T:Startup-Sequence
  echo "; Load patched scsi.device v43.45, if it exists" >T:Startup-Sequence
  echo "IF EXISTS DEVS:scsi.device" >>T:Startup-Sequence
  echo "  ; Load scsi.device, if current loaded scsi.device is less than v43.45" >>T:Startup-Sequence
  echo "  Version >NIL: *"scsi.device*" 43 45" >>T:Startup-Sequence
  echo "  IF WARN" >>T:Startup-Sequence
  echo "    LoadModule DEVS:scsi.device" >>T:Startup-Sequence
  echo "  ENDIF" >>T:Startup-Sequence
  echo "ENDIF" >>T:Startup-Sequence
  echo "" >>T:Startup-Sequence
  Type SYSTEMDIR:S/Startup-Sequence >>T:Startup-Sequence
  Copy T:Startup-Sequence SYSTEMDIR:S/Startup-Sequence
ENDIF


; done message
echo "Done"
echo ""
echo "Amiga OS 3.9 installation is complete."

SKIP end


; fail
; ----
LAB fail

echo ""
echo "Amiga OS 3.9 installation failed and has stopped"
echo "installation process."
quit


; end
; ---
LAB end

echo ""
ask "Press ENTER to continue"
